<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Struktur Kelas PAI B 2025</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'crimson-dark': '#1a0505', 'crimson-main': '#8a0000', },
                    fontFamily: { 'tech': ['Orbitron', 'sans-serif'], 'body': ['Poppins', 'sans-serif'], }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0a0000; color: #e5e5e5; overflow-x: hidden; font-family: 'Poppins', sans-serif; }
        .glass-panel { background: rgba(40, 0, 0, 0.6); border: 1px solid rgba(255, 50, 50, 0.1); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .fullscreen-overlay, .edit-modal, .custom-modal { position: fixed; inset: 0; width: 100%; height: 100%; z-index: 100; overflow: auto; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; display: flex; justify-content: center; align-items: center; }
        .fullscreen-overlay { background: rgba(10, 0, 0, 0.95); transform: scale(0.9); transition: transform 0.3s ease, opacity 0.3s ease; display: block; }
        .edit-modal { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); z-index: 200; }
        .custom-modal { background: rgba(0,0,0,0.9); z-index: 200; }
        .open, .active { opacity: 1; pointer-events: auto; transform: scale(1); }
        .empty-slot { border: 1px dashed rgba(150, 150, 150, 0.3); background: rgba(20, 0, 0, 0.2); }
        .empty-slot:hover { border-color: #ef4444; border-style: solid; }
        .card-container { width: 150px; height: 240px; }
        @media (min-width: 768px) { .card-container { width: 240px; height: 360px; } }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #0f0505; }
        ::-webkit-scrollbar-thumb { background: #8a0000; border-radius: 6px; border: 2px solid #0f0505; }
        ::-webkit-scrollbar-thumb:hover { background: #ff0000; }
        * { scrollbar-width: thin; scrollbar-color: #8a0000 #0f0505; }
        .blur-content { filter: blur(8px); pointer-events: none; user-select: none; transition: filter 0.3s ease; }
    </style>
</head>
<body class="selection:bg-red-500 selection:text-white">

    <div class="fixed inset-0 z-[-1] overflow-hidden pointer-events-none">
        <div class="absolute inset-0 bg-gradient-to-b from-black via-[#1a0000] to-black opacity-80"></div>
    </div>

    <!-- WRAPPER UTAMA -->
    <div id="main-content-wrapper" class="transition-all duration-300">
        <main class="min-h-screen pt-10 px-4 md:px-8 max-w-7xl mx-auto w-full">
            <section id="structure" class="py-10 relative min-h-[600px]">
                <div class="mb-12">
                    <div class="text-center mb-6">
                        <h2 class="text-4xl md:text-6xl font-tech font-bold text-white mb-4 uppercase tracking-wider">STRUKTUR KELAS</h2>
                        <div class="h-2 w-32 bg-red-600 mx-auto rounded-full shadow-[0_0_15px_rgba(220,38,38,0.7)]"></div>
                    </div>
                    <div class="max-w-4xl mx-auto px-4 flex justify-center">
                        <div class="relative w-full max-w-xl flex items-center justify-center bg-black/40 h-20 rounded-full border-2 border-red-900/30 backdrop-blur-sm">
                            <button onclick="prevSemester()" id="btn-prev-sem" class="absolute left-6 z-20 text-3xl text-red-600 hover:text-white transform active:scale-90 transition-transform"><i class="fas fa-chevron-left"></i></button>
                            <div class="text-center w-full"><h3 id="current-semester-display" class="font-tech text-3xl md:text-4xl text-white font-bold tracking-[0.2em] transition-all">SEMESTER I</h3></div>
                            <button onclick="nextSemester()" id="btn-next-sem" class="absolute right-6 z-20 text-3xl text-red-600 hover:text-white transform active:scale-90 transition-transform"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                </div>

                <div id="structure-content-container" class="w-full overflow-x-auto padding-bottom-2rem flex justify-center min-h-[500px] py-8">
                     <!-- Loading Indicator -->
                     <div class="text-center text-red-500 animate-pulse mt-10">
                        <i class="fas fa-circle-notch fa-spin text-4xl"></i>
                        <p class="mt-2 font-tech">MEMUAT DATA...</p>
                     </div>
                </div>

                <div class="text-center pb-12 mt-8 flex flex-col gap-4 items-center">
                      <button id="btn-team-executor" onclick="toggleTeamExecutor()" class="px-10 py-4 bg-gradient-to-r from-orange-700 to-black rounded-xl border border-orange-500/50 shadow-lg hover:shadow-orange-600/40 transition-all hidden group hover:scale-105 cursor-pointer z-10">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-network-wired text-3xl text-orange-400 group-hover:text-white transition-colors"></i>
                            <span class="font-tech text-xl font-bold text-white tracking-widest uppercase">TEAM EXECUTOR</span>
                        </div>
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- MODAL TEAM EXECUTOR -->
    <div id="team-executor-modal" class="fullscreen-overlay">
        <div class="w-full min-h-screen pt-10 pb-10 flex flex-col">
             <button onclick="toggleTeamExecutor()" class="fixed top-4 right-4 z-[200] bg-black/50 hover:bg-red-600 text-white w-14 h-14 rounded-full border-2 border-red-500/30 flex items-center justify-center shadow-lg text-xl transition-all cursor-pointer"><i class="fas fa-times"></i></button>
            <div class="text-center mb-16 px-4 relative z-10"><h2 class="text-4xl md:text-6xl font-tech font-bold text-white uppercase tracking-widest drop-shadow-lg">TEAM EXECUTOR</h2></div>
            <div id="executor-tree-container" class="flex-grow flex items-start justify-center overflow-auto px-4 pb-20"></div>
        </div>
    </div>

    <!-- MODAL PASSWORD -->
    <div id="password-modal" class="custom-modal">
        <div class="bg-[#0f0505] border-2 border-red-800 rounded-2xl p-8 max-w-xs w-full mx-4 shadow-[0_0_50px_rgba(139,0,0,0.5)] text-center">
            <div class="mb-6">
                <i class="fas fa-shield-halved text-5xl text-red-600 mb-4 animate-pulse"></i>
                <h3 class="text-xl font-bold text-white font-tech uppercase tracking-widest">KEAMANAN</h3>
                <p class="text-gray-400 text-xs mt-2 uppercase tracking-wide">Masukkan Password Admin</p>
            </div>
            <input type="password" id="admin-password" class="w-full bg-black border-2 border-gray-800 rounded-xl py-3 px-4 text-white text-center focus:border-red-600 mb-2 tracking-[0.5em] text-lg transition-colors outline-none" placeholder="••••••••">
            <p id="password-error" class="text-red-500 text-[10px] mb-4 hidden font-bold tracking-wide bg-red-950/30 py-1 rounded">PASSWORD SALAH!</p>
            <div class="flex gap-3 mt-4">
                <button onclick="closePasswordModal()" class="flex-1 py-3 rounded-xl border border-gray-700 text-gray-400 text-xs font-bold uppercase hover:bg-gray-900 transition-colors">Batal</button>
                <button id="btn-confirm-save" onclick="confirmAction()" class="flex-1 py-3 rounded-xl bg-red-700 text-white font-bold hover:bg-red-600 text-xs uppercase tracking-wider shadow-lg hover:shadow-red-900/50 transition-all flex justify-center items-center gap-2">
                    <span>KONFIRMASI</span>
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL EDIT / PREVIEW -->
    <div id="edit-modal" class="edit-modal">
        <div class="bg-[#0f0505] border-2 border-red-800 rounded-3xl p-8 max-w-sm w-full mx-4 shadow-[0_0_60px_rgba(200,0,0,0.3)] relative">
            <button onclick="closeEditModal()" class="absolute top-5 right-5 text-gray-400 hover:text-white transition-colors"><i class="fas fa-times text-2xl"></i></button>

            <div id="edit-form-container">
                <h3 class="text-2xl font-bold text-white mb-8 font-tech uppercase flex items-center gap-3"><i class="fas fa-user-pen text-red-500"></i> EDIT DATA</h3>
                <div class="mb-8">
                    <label class="block text-red-500 text-xs font-bold uppercase mb-3 tracking-wider">Nama Lengkap</label>
                    <input type="text" id="input-name" class="w-full bg-black/50 border border-gray-700 rounded-xl py-4 px-5 text-white focus:border-red-500 focus:outline-none transition-all placeholder-gray-600 text-lg" placeholder="Ketik nama disini..." autocomplete="off">
                </div>
                <div class="flex gap-4">
                    <button onclick="closeEditModal()" class="flex-1 py-3 rounded-xl border border-gray-700 text-gray-400 text-sm font-bold uppercase hover:bg-gray-900 transition-all">Batal</button>
                    <button onclick="initiateAction('save')" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-red-800 to-red-600 text-white font-bold hover:from-red-700 hover:to-red-500 text-sm uppercase tracking-wide shadow-lg hover:shadow-red-500/30 transition-all">Simpan</button>
                </div>
            </div>

            <div id="preview-container" class="hidden flex-col items-center text-center">
                <h3 class="text-2xl font-bold text-white mb-2 font-tech uppercase tracking-[0.2em] text-red-500">ANGGOTA</h3>
                <div class="w-full aspect-square bg-gradient-to-b from-gray-800 to-black rounded-2xl overflow-hidden mb-6 mt-6 border-4 border-red-900/50 shadow-2xl relative group">
                     <!-- REFERRER POLICY PENTING UNTUK GOOGLE DRIVE -->
                     <img id="preview-img" src="" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" referrerpolicy="no-referrer">
                </div>
                <h4 id="preview-name" class="text-white font-bold text-2xl mb-8 font-body tracking-wide">Nama</h4>
                <button onclick="initiateAction('delete')" class="w-full py-4 rounded-xl bg-red-950/30 border border-red-600/50 text-red-500 hover:bg-red-600 hover:text-white transition-all font-bold uppercase tracking-widest flex items-center justify-center gap-3 group">
                    <i class="fas fa-trash-alt group-hover:rotate-12 transition-transform"></i> HAPUS DATA
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- KONFIGURASI PENTING ---
        // MASUKKAN URL HASIL DEPLOY GOOGLE APPS SCRIPT DI SINI (CONTOH: https://script.google.com/.../exec)
        const STRUCTURE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzTJzR1VxWjb34ierpE9u2DuSSdu2wfiajG56fOzw1ovxZGzUdXdnYHAC93mt8nHwkzGQ/exec"; 

        // DATA DEFAULT (Jaga-jaga jika internet mati atau server error)
        let dbMahasiswa = {}; 

        const semesterList = ["I", "II", "III", "IV", "V", "VI", "VII", "VIII"];
        let currentSemesterIndex = 0;
        let currentEditTarget = null;
        let pendingAction = null; 
        let semesterData = {}; 
        let SERVER_PASSWORD = ""; 
        const LOCAL_STORAGE_KEY = "pai_structure_data_v3";

        // --- FUNGSI FIX LINK GOOGLE DRIVE AGAR MUNCUL DI SEMUA DEVICE ---
        // Mengubah ID atau Link menjadi format Thumbnail High-Res
        function convertDriveLink(urlOrId) {
            if (!urlOrId) return "";
            if (urlOrId.includes("ui-avatars")) return urlOrId;
            
            let fileId = urlOrId;
            if (urlOrId.includes("/d/")) {
                fileId = urlOrId.split("/d/")[1].split("/")[0];
            } else if (urlOrId.includes("id=")) {
                fileId = urlOrId.split("id=")[1].split("&")[0];
            }
            
            // Format ini lebih stabil daripada lh3.googleusercontent
            return `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
        }

        function enterFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) { elem.requestFullscreen().catch(err => console.log(err)); }
        }

        window.onload = function() {
            loadFromLocal();
            updateSemesterDisplay();
            
            if(STRUCTURE_SCRIPT_URL) {
                const antiCacheUrl = STRUCTURE_SCRIPT_URL + "?v=" + new Date().getTime();
                loadStructureData(antiCacheUrl); 
            } else {
                console.warn("Script URL belum diisi! Hubungkan dengan Google Apps Script.");
            }
            
            document.getElementById('input-name').addEventListener('keypress', (e) => { if (e.key === 'Enter') initiateAction('save'); });
            document.getElementById('admin-password').addEventListener('keypress', (e) => { if (e.key === 'Enter') confirmAction(); });

            document.body.addEventListener('click', function() {
                if (!document.fullscreenElement) enterFullscreen();
            }, { once: true });
        };

        function saveToLocal() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(semesterData));
        }

        function loadFromLocal() {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedData) {
                try { semesterData = JSON.parse(savedData); } catch (e) { console.error("Parse Error", e); }
            }
        }

        async function loadStructureData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                
                const data = await response.json();
                
                // 1. ISI DATABASE PENCARIAN
                if (data.dbMahasiswa) {
                    dbMahasiswa = { ...dbMahasiswa, ...data.dbMahasiswa };
                    console.log("Database Mahasiswa loaded:", Object.keys(dbMahasiswa).length);
                }

                // 2. ISI STRUKTUR DARI SERVER
                // Asumsi server mengembalikan struktur untuk semester aktif atau default
                // Kita map 'main' dan 'executor' ke semester aktif
                const sem = semesterList[currentSemesterIndex];
                if(data.main || data.executor) {
                    if(!semesterData[sem]) semesterData[sem] = {};
                    if(data.main) semesterData[sem].main = data.main;
                    if(data.executor) semesterData[sem].executor = data.executor;
                    saveToLocal();
                }

                if(data.meta && data.meta.password) SERVER_PASSWORD = data.meta.password;
                
                updateStructureUI(sem);
                
            } catch (error) { 
                console.warn("Gagal Sync Server. Menggunakan data lokal.", error);
                if (!semesterData[semesterList[currentSemesterIndex]]) {
                    semesterData[semesterList[currentSemesterIndex]] = getSemesterData(semesterList[currentSemesterIndex]);
                }
                updateStructureUI(semesterList[currentSemesterIndex]);
            }
        }

        function getSemesterData(sem) {
            if (!semesterData[sem]) {
                semesterData[sem] = { 
                    main: { ketua: { name: "", img: "", nim: "" }, wakil: {name:"", img:"", nim:""}, sek1: { name: "", img: "", nim: "" }, sek2: { name: "", img: "", nim: "" }, ben: { name: "", img: "", nim: "" }, ben1: { name: "", img: "", nim: "" }, ben2: { name: "", img: "", nim: "" } },
                    executor: { koor: { name: "", img: "", nim: "" }, div_kreatif: Array(6).fill({name: "", img: "", nim: ""}), div_kebersihan: Array(5).fill({name: "", img: "", nim: ""}), div_sosial: Array(6).fill({name: "", img: "", nim: ""}) }
                };
            }
            return semesterData[sem];
        }

        function initiateAction(action) {
            pendingAction = action;
            document.getElementById('password-error').classList.add('hidden');
            document.getElementById('admin-password').value = '';
            const btn = document.getElementById('btn-confirm-save');
            btn.innerText = "KONFIRMASI";
            btn.classList.remove('bg-gray-600', 'bg-green-600', 'bg-red-600');
            btn.classList.add('bg-red-700');
            btn.disabled = false;
            
            document.getElementById('edit-modal').classList.remove('active');
            setTimeout(() => {
                document.getElementById('password-modal').classList.add('active');
                document.getElementById('admin-password').focus();
            }, 200);
        }

        function closePasswordModal() {
            document.getElementById('password-modal').classList.remove('active');
            pendingAction = null;
        }

        function confirmAction() {
            const password = document.getElementById('admin-password').value;
            if(SERVER_PASSWORD && password !== SERVER_PASSWORD) {
                document.getElementById('password-error').classList.remove('hidden');
                return; 
            }
            if(pendingAction === 'save') saveMember(false, password);
            else if (pendingAction === 'delete') saveMember(true, password);
        }

        async function saveMember(isClear = false, usedPassword = "") {
            if (!currentEditTarget) return;
            
            const btn = document.getElementById('btn-confirm-save');
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> MENYIMPAN...`;
            btn.disabled = true;

            const input = document.getElementById('input-name');
            const newName = isClear ? "" : input.value.trim();
            const { type, key, index } = currentEditTarget;
            const sem = semesterList[currentSemesterIndex];
            const currentDataObj = getSemesterData(sem);
            
            let matchedImg = "";
            let matchedNim = "";

            if (!isClear && newName) {
                // LOGIC PENCARIAN DI DATABASE MAHASISWA (SHEET DB_MAHASISWA)
                // Ini kunci agar foto otomatis muncul!
                const foundKey = Object.keys(dbMahasiswa).find(k => k.toLowerCase() === newName.toLowerCase());
                
                if (foundKey) {
                    matchedImg = dbMahasiswa[foundKey].img; // Ambil ID dari DB
                    matchedNim = dbMahasiswa[foundKey].nim;
                } else {
                    // Jika tidak ada di DB, pakai avatar
                    matchedImg = `https://ui-avatars.com/api/?name=${encodeURIComponent(newName)}&background=300505&color=ffffff&bold=true`;
                    matchedNim = "-"; 
                }
            }

            // Data yang akan disimpan ke struktur
            const newData = { name: newName, img: matchedImg, nim: matchedNim };

            // Update Tampilan Lokal
            if (type === 'main') currentDataObj.main[key] = newData;
            else {
                if (index !== null) currentDataObj.executor[key][index] = newData;
                else currentDataObj.executor[key] = newData;
            }
            saveToLocal();
            
            // Refresh UI
            if(sem === "I") updateStructureUI(sem); 
            else {
                if (type === 'main') renderMainStructure(currentDataObj.main);
                else if(document.getElementById('team-executor-modal').classList.contains('open')) renderTeamExecutorTree(currentDataObj.executor);
            }

            // Kirim ke Google Sheet (Simpan Permanen)
            if(STRUCTURE_SCRIPT_URL) {
                try {
                    const response = await fetch(STRUCTURE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', // Penting agar tidak error CORS
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ 
                            password: usedPassword,
                            semester: sem,
                            key, index, 
                            name: newData.name, 
                            img: newData.img,
                            nim: newData.nim,
                        })
                    });

                    btn.innerHTML = `<i class="fas fa-check"></i> BERHASIL`;
                    btn.classList.replace('bg-red-700', 'bg-green-600');
                    setTimeout(() => closePasswordModal(), 1000);

                } catch (e) { 
                    console.error("Gagal simpan ke Cloud:", e);
                    btn.innerHTML = `<i class="fas fa-exclamation-triangle"></i> GAGAL KONEKSI`;
                    setTimeout(() => closePasswordModal(), 2000);
                }
            } else {
                btn.innerHTML = `<i class="fas fa-check"></i> LOKAL OK`;
                setTimeout(() => closePasswordModal(), 1000);
            }
            
            input.value = "";
            currentEditTarget = null;
        }

        function updateSemesterDisplay() { 
            const sem = semesterList[currentSemesterIndex]; 
            const teamExecutorBtn = document.getElementById('btn-team-executor');
            const displayEl = document.getElementById('current-semester-display');

            document.getElementById('btn-prev-sem').style.visibility = (currentSemesterIndex === 0) ? 'hidden' : 'visible';
            document.getElementById('btn-next-sem').style.visibility = (currentSemesterIndex === semesterList.length - 1) ? 'hidden' : 'visible';
            if(teamExecutorBtn) teamExecutorBtn.style.display = (currentSemesterIndex === 0) ? 'none' : 'block';

            displayEl.innerText = `SEMESTER ${sem}`;
            updateStructureUI(sem); 
        }

        function nextSemester() { if (currentSemesterIndex < semesterList.length - 1) { currentSemesterIndex++; updateSemesterDisplay(); } }
        function prevSemester() { if (currentSemesterIndex > 0) { currentSemesterIndex--; updateSemesterDisplay(); } }

        function updateStructureUI(sem) { 
            const container = document.getElementById('structure-content-container'); 
            
            // Fungsi Pembantu: Pastikan link foto valid
            const getMhs = (sourceData) => {
                if (!sourceData || !sourceData.name) return { name: "", img: "", nim: "" };
                
                let finalImg = sourceData.img;
                
                // Cek lagi ke DB Local jika link kosong atau format UI Avatar
                if ((!finalImg || finalImg.includes("ui-avatars")) && dbMahasiswa[sourceData.name]) {
                     finalImg = dbMahasiswa[sourceData.name].img;
                }
                
                return { 
                    name: sourceData.name, 
                    img: convertDriveLink(finalImg), 
                    nim: sourceData.nim || (dbMahasiswa[sourceData.name] ? dbMahasiswa[sourceData.name].nim : "-")
                };
            };

            const rawData = getSemesterData(sem);

            if (sem === "I") {
                const data = { 
                    ketua: getMhs(rawData.main.ketua), 
                    wakil: getMhs(rawData.main.wakil), 
                    sek1: getMhs(rawData.main.sek1), 
                    sek2: getMhs(rawData.main.sek2), 
                    ben1: getMhs(rawData.main.ben1), 
                    ben2: getMhs(rawData.main.ben2) 
                };
                
                container.innerHTML = `
                <div class="flex flex-col items-center w-full gap-12 mt-4">
                    <div class="flex justify-center">${createStaticCard(data.ketua.img, data.ketua.name, data.ketua.nim, "Ketua")}</div>
                    <div class="flex justify-center">${createStaticCard(data.wakil.img, data.wakil.name, data.wakil.nim, "Wakil")}</div>
                    <div class="flex flex-wrap justify-center gap-8 md:gap-12">
                        ${createStaticCard(data.sek1.img, data.sek1.name, data.sek1.nim, "Sekretaris 1")}
                        ${createStaticCard(data.sek2.img, data.sek2.name, data.sek2.nim, "Sekretaris 2")}
                        ${createStaticCard(data.ben1.img, data.ben1.name, data.ben1.nim, "Bendahara 1")}
                        ${createStaticCard(data.ben2.img, data.ben2.name, data.ben2.nim, "Bendahara 2")}
                    </div>
                </div>`;
            } else {
                renderMainStructure(rawData.main);
            }
        }

        function renderMainStructure(dataMain) {
             const resolveData = (data) => {
                if(!data || !data.name) return data;
                // Auto-fix data dari DB jika tersedia
                const found = Object.keys(dbMahasiswa).find(k => k.toLowerCase() === data.name.toLowerCase());
                return found ? { ...data, img: dbMahasiswa[found].img, nim: dbMahasiswa[found].nim } : data;
            };

            const container = document.getElementById('structure-content-container');
            // Menyesuaikan jika ada Wakil atau Bendahara tunggal
            container.innerHTML = `
            <div class="flex flex-col items-center w-full gap-12 mt-4">
                <div class="flex justify-center">${createDynamicCard('ketua', "Ketua Kelas", resolveData(dataMain.ketua))}</div>
                ${ dataMain.wakil ? `<div class="flex justify-center">${createDynamicCard('wakil', "Wakil Ketua", resolveData(dataMain.wakil))}</div>` : '' }
                <div class="flex flex-wrap justify-center gap-8 md:gap-12">
                    ${createDynamicCard('sek1', "Sekretaris 1", resolveData(dataMain.sek1))}
                    ${createDynamicCard('sek2', "Sekretaris 2", resolveData(dataMain.sek2))}
                    ${createDynamicCard('ben', "Bendahara", resolveData(dataMain.ben))}
                </div>
            </div>`;
        }

        function renderTeamExecutorTree(dataEx) {
             const resolveData = (data) => {
                if(!data || !data.name) return data;
                const found = Object.keys(dbMahasiswa).find(k => k.toLowerCase() === data.name.toLowerCase());
                return found ? { ...data, img: dbMahasiswa[found].img, nim: dbMahasiswa[found].nim } : data;
            };

            const container = document.getElementById('executor-tree-container');
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-16 mt-10 w-full max-w-7xl">
                    <div class="flex flex-col items-center gap-6">
                        <div class="w-full bg-orange-900/20 border border-orange-500/30 rounded-xl py-3 text-center mb-2 shadow-[0_0_15px_rgba(251,146,60,0.1)]">
                            <div class="text-orange-400 text-xl font-bold font-tech uppercase tracking-[0.2em]">KREATIF</div>
                        </div>
                        <div class="flex flex-wrap justify-center gap-6">${dataEx.div_kreatif.map((m, i) => createDynamicCard('div_kreatif', `Team ${i+1}`, resolveData(m), 'executor', i)).join('')}</div>
                    </div>
                    <div class="flex flex-col items-center gap-6">
                         <div class="w-full bg-red-900/20 border border-red-500/30 rounded-xl py-3 text-center mb-2 shadow-[0_0_15px_rgba(248,113,113,0.1)]">
                            <div class="text-red-400 text-xl font-bold font-tech uppercase tracking-[0.2em]">KEBERSIHAN</div>
                        </div>
                        <div class="flex flex-wrap justify-center gap-6">${dataEx.div_kebersihan.map((m, i) => createDynamicCard('div_kebersihan', `Team ${i+1}`, resolveData(m), 'executor', i)).join('')}</div>
                    </div>
                    <div class="flex flex-col items-center gap-6">
                         <div class="w-full bg-yellow-900/20 border border-yellow-500/30 rounded-xl py-3 text-center mb-2 shadow-[0_0_15px_rgba(250,204,21,0.1)]">
                            <div class="text-yellow-400 text-xl font-bold font-tech uppercase tracking-[0.2em]">SOSIAL</div>
                        </div>
                        <div class="flex flex-wrap justify-center gap-6">${dataEx.div_sosial.map((m, i) => createDynamicCard('div_sosial', `Team ${i+1}`, resolveData(m), 'executor', i)).join('')}</div>
                    </div>
                </div>`;
        }

        function createStaticCard(img, name, nim, role) { 
            return `
            <div class="glass-panel p-4 rounded-2xl inline-flex flex-col card-container mx-2 mb-4 justify-between">
                <div class="flex-grow flex items-center justify-center w-full">
                    <div class="w-20 h-20 md:w-32 md:h-32 rounded-full overflow-hidden border-2 border-red-500 shadow-lg group relative">
                        <img src="${img}" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=300505&color=ffffff&bold=true'" class="w-full h-full object-cover transition-transform duration-500 hover:scale-110" referrerpolicy="no-referrer" loading="lazy">
                    </div>
                </div>
                <div class="flex flex-col items-center w-full">
                    <h3 class="font-bold text-white text-xs md:text-sm leading-tight text-center mb-1 px-1 line-clamp-2">${name}</h3>
                    <p class="text-red-500 text-[10px] md:text-xs font-tech font-bold tracking-wider mb-2">${nim || "-"}</p>
                    <p class="text-[10px] md:text-xs text-gray-400 uppercase tracking-wider pt-3 border-t border-white/10 w-full text-center">${role}</p>
                </div>
            </div>`; 
        }

        function createDynamicCard(key, label, data, type = 'main', index = null) {
            const name = data?.name || "";
            const nim = data?.nim || "";
            // Logic konversi link ada disini
            const imgUrl = name ? (convertDriveLink(data.img) || "https://ui-avatars.com/api/?name=User&background=300505&color=ffffff") : "";
            const params = `'${type}', '${key}'${index !== null ? `, ${index}` : ''}`;

            if (!name) return `
                <div class="glass-panel empty-slot p-4 rounded-2xl inline-flex flex-col card-container cursor-pointer mx-2 mb-4 group overflow-hidden transition-all duration-300 hover:scale-105 hover:shadow-[0_0_20px_rgba(220,38,38,0.3)]" onclick="openEditModal(${params})">
                    <div class="flex-grow flex flex-col items-center justify-center">
                        <div class="w-20 h-20 md:w-32 md:h-32 rounded-full mb-3 flex items-center justify-center border-2 border-dashed border-gray-600 text-gray-600 group-hover:text-red-500 group-hover:border-red-500 transition-colors text-3xl">
                            <i class="fas fa-plus"></i>
                        </div>
                        <span class="text-xs md:text-sm text-gray-500 group-hover:text-red-400 transition-colors font-semibold uppercase tracking-wider">Isi Data</span>
                    </div>
                    <p class="text-[10px] md:text-xs text-gray-600 uppercase mt-auto flex-shrink-0 pt-3 border-t border-white/5 tracking-wider w-full text-center">${label}</p>
                </div>`;

            return `
                <div class="glass-panel p-4 rounded-2xl inline-flex flex-col card-container cursor-pointer mx-2 mb-4 group transition-all duration-300 hover:scale-105 hover:shadow-[0_0_25px_rgba(220,38,38,0.4)] hover:border-red-500/50 justify-between" onclick="openEditModal(${params})">
                    <div class="flex-grow flex items-center justify-center w-full">
                        <img src="${imgUrl}" class="w-20 h-20 md:w-32 md:h-32 object-cover rounded-full border-2 border-gray-500 group-hover:border-red-500 flex-shrink-0 transition-all duration-300 shadow-lg" referrerpolicy="no-referrer" loading="lazy">
                    </div>
                    <div class="flex flex-col items-center w-full">
                        <h3 class="font-bold text-white text-xs md:text-sm leading-tight text-center mb-1 px-1 group-hover:text-red-200 transition-colors">${name}</h3>
                        <p class="text-red-500 text-[10px] md:text-xs font-tech font-bold tracking-wider mb-2 group-hover:text-red-400 transition-colors">${nim || "-"}</p>
                        <p class="text-[10px] md:text-xs text-red-400 uppercase font-tech pt-3 border-t border-white/10 w-full tracking-wider group-hover:text-red-300 text-center">${label}</p>
                    </div>
                </div>`;
        }

        function openEditModal(type, key, index = null) {
            currentEditTarget = { type, key, index };
            const data = getSemesterData(semesterList[currentSemesterIndex]);
            let target = (type === 'main') ? data.main[key] : (index !== null ? data.executor[key][index] : data.executor[key]);
            
            // Auto-populate data from DB if exists
            if(target && target.name) {
                const found = Object.keys(dbMahasiswa).find(k => k.toLowerCase() === target.name.toLowerCase());
                if(found) {
                    target.img = dbMahasiswa[found].img;
                    target.nim = dbMahasiswa[found].nim;
                }
            }

            const modal = document.getElementById('edit-modal');
            const form = document.getElementById('edit-form-container');
            const preview = document.getElementById('preview-container');

            modal.classList.add('active');
            if (target && target.name) {
                form.classList.add('hidden');
                preview.classList.remove('hidden');
                preview.classList.add('flex');
                
                document.getElementById('preview-img').src = convertDriveLink(target.img) || "https://ui-avatars.com/api/?name=User";
                document.getElementById('preview-name').innerText = target.name;
            } else {
                form.classList.remove('hidden');
                preview.classList.add('hidden');
                document.getElementById('input-name').value = "";
                setTimeout(() => document.getElementById('input-name').focus(), 100);
            }
        }

        function closeEditModal() { document.getElementById('edit-modal').classList.remove('active'); }
        
        function toggleTeamExecutor() { 
            const m = document.getElementById('team-executor-modal');
            const mainContent = document.getElementById('main-content-wrapper');

            if(m.classList.contains('open')) {
                m.classList.remove('open');
                mainContent.classList.remove('blur-content');
                document.body.style.overflow = ''; 
            } else {
                renderTeamExecutorTree(getSemesterData(semesterList[currentSemesterIndex]).executor); 
                m.classList.add('open');
                mainContent.classList.add('blur-content');
                document.body.style.overflow = 'hidden';
            }
        }
    </script>
</body>
</html>

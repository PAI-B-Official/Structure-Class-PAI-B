<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Struktur Kelas PAI B 2025</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- CROPPER.JS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'crimson-dark': '#1a0505',
                        'crimson-main': '#8a0000',
                    },
                    fontFamily: {
                        'tech': ['Orbitron', 'sans-serif'],
                        'body': ['Poppins', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'shake': 'shake 0.4s cubic-bezier(.36,.07,.19,.97) both',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #0a0000; 
            color: #e5e5e5; 
            overflow-x: hidden; 
            font-family: 'Poppins', sans-serif; 
            touch-action: pan-y;
            -webkit-font-smoothing: antialiased;
        }
        
        .glass-panel { 
            background: rgba(40, 0, 0, 0.7); 
            border: 1px solid rgba(255, 50, 50, 0.15); 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); 
            backdrop-filter: blur(4px); 
            -webkit-backdrop-filter: blur(4px); 
            transform: translateZ(0);
            will-change: transform, opacity;
            transition: transform 0.2s ease, box-shadow 0.2s ease; 
        }
        
        .fullscreen-overlay, .edit-modal, .custom-modal { position: fixed; inset: 0; width: 100%; height: 100%; z-index: 100; overflow: auto; opacity: 0; pointer-events: none; transition: opacity 0.2s ease; display: flex; justify-content: center; align-items: center; }
        .fullscreen-overlay { background: #0a0000; display: block; }
        .edit-modal { background: rgba(0, 0, 0, 0.9); z-index: 200; }
        .custom-modal { background: rgba(0,0,0,0.95); z-index: 200; }
        .open, .active { opacity: 1; pointer-events: auto; }
        
        .empty-slot { border: 1px dashed rgba(150, 150, 150, 0.3); background: rgba(20, 0, 0, 0.2); }
        .empty-slot:hover { border-color: #ef4444; border-style: solid; }
        
        /* CARD SIZE */
        .card-container { width: 100%; height: auto; aspect-ratio: 9/15; margin: 0; }
        @media (min-width: 768px) { .card-container { width: 250px; height: 400px; margin: 0 auto; aspect-ratio: auto; } }
        
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f0505; }
        ::-webkit-scrollbar-thumb { background: #8a0000; border-radius: 4px; }
        .blur-content { filter: blur(5px); pointer-events: none; user-select: none; transition: filter 0.2s ease; }

        /* CROPPER STYLE OVERRIDES */
        .cropper-view-box, .cropper-face { border-radius: 0; outline: 1px solid #fff; }
        .cropper-line, .cropper-point { background-color: #ef4444; }
        .cropper-modal { background-color: #000; opacity: 0.8; }
    </style>
</head>
<body class="selection:bg-red-500 selection:text-white">

    <div class="fixed inset-0 z-[-1] overflow-hidden pointer-events-none">
        <div class="absolute inset-0 bg-gradient-to-b from-black via-[#1a0000] to-black"></div>
    </div>

    <button onclick="toggleFullscreen()" class="fixed bottom-6 right-6 z-50 text-white bg-red-900/90 w-12 h-12 md:w-14 md:h-14 rounded-full border border-red-500/50 hover:bg-red-700 transition-all shadow-lg flex items-center justify-center group active:scale-95">
        <i id="fs-icon" class="fas fa-expand text-lg md:text-xl"></i>
    </button>

    <div id="main-content-wrapper" class="transition-opacity duration-300">
        <main class="min-h-screen pt-4 md:pt-8 px-1 md:px-8 max-w-7xl mx-auto w-full">
            <section id="structure" class="py-6 relative min-h-[600px]">
                <div class="mb-6">
                    <div class="text-center mb-6">
                        <h2 class="text-3xl md:text-6xl font-tech font-bold text-white mb-3 uppercase tracking-wider">STRUKTUR KELAS</h2>
                        <div class="h-1.5 w-24 md:w-32 bg-red-600 mx-auto rounded-full shadow-red-glow"></div>
                        <div id="loading-indicator" class="mt-4 text-red-400 text-xs md:text-sm font-tech hidden"><i class="fas fa-circle-notch fa-spin mr-2"></i> MENGHUBUNGKAN...</div>
                    </div>

                    <div class="max-w-4xl mx-auto px-2 flex flex-col items-center justify-center">
                        <div class="relative w-full max-w-xl flex items-center justify-center bg-gradient-to-r from-red-950 via-black to-red-950 h-16 md:h-20 rounded-xl border border-red-600/50 shadow-[0_0_15px_rgba(220,38,38,0.3)] overflow-hidden">
                            <button onclick="prevSemester()" id="btn-prev-sem" class="hidden md:block absolute left-0 h-full px-6 z-20 text-3xl text-red-600 hover:text-white hover:bg-red-900/30 transition-all"><i class="fas fa-chevron-left"></i></button>
                            <div class="text-center w-full flex flex-col items-center justify-center h-full">
                                <h3 id="current-semester-display" class="font-tech text-2xl md:text-4xl text-white font-bold tracking-[0.1em] transition-all drop-shadow-md">SEMESTER I</h3>
                            </div>
                            <button onclick="nextSemester()" id="btn-next-sem" class="hidden md:block absolute right-0 h-full px-6 z-20 text-3xl text-red-600 hover:text-white hover:bg-red-900/30 transition-all"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <button onclick="refreshData()" id="btn-refresh" class="mt-3 group relative px-4 py-2 bg-black/60 rounded-full border border-red-800/60 hover:border-red-500 hover:bg-red-950/40 transition-all active:scale-95">
                            <div class="flex items-center gap-2 text-xs text-red-200/70 group-hover:text-white font-tech tracking-wider"><i class="fas fa-sync-alt group-hover:rotate-180 transition-transform duration-500"></i> REFRESH</div>
                        </button>
                        <div class="md:hidden mt-3 text-gray-600 text-[10px] flex items-center gap-2"><i class="fas fa-chevron-left"></i> <span>GESER UNTUK GANTI SEMESTER</span> <i class="fas fa-chevron-right"></i></div>
                    </div>
                </div>

                <div id="structure-content-wrapper" class="transition-opacity duration-200 ease-out opacity-100">
                    <div id="structure-content-container" class="w-full overflow-x-hidden flex justify-center min-h-[500px] py-2"></div>
                </div>

                <div id="executor-btn-container" class="text-center pb-24 mt-8 flex-col gap-4 items-center hidden">
                     <button onclick="openModalWithHistory('team-executor-modal')" class="px-8 py-3 md:px-10 md:py-4 bg-gradient-to-r from-orange-800 to-black rounded-xl border border-orange-600/50 shadow-lg hover:shadow-orange-600/30 transition-transform active:scale-95 cursor-pointer z-10 w-full max-w-xs md:w-auto">
                        <div class="flex items-center justify-center gap-3"><i class="fas fa-network-wired text-2xl md:text-3xl text-orange-400"></i><span class="font-tech text-lg md:text-xl font-bold text-white tracking-widest uppercase">TEAM EXECUTOR</span></div>
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- MODAL TEAM EXECUTOR -->
    <div id="team-executor-modal" class="fullscreen-overlay">
        <div class="w-full min-h-screen pt-4 pb-10 flex flex-col bg-[#050000]">
             <button onclick="closeModalWithHistory('team-executor-modal')" class="fixed top-4 right-4 z-[200] bg-gray-800 text-white w-12 h-12 rounded-full border border-gray-600 flex items-center justify-center shadow-lg text-lg transition-transform active:scale-90"><i class="fas fa-times"></i></button>
            <div class="text-center mb-8 px-4 mt-8 relative z-10"><h2 class="text-3xl md:text-5xl font-tech font-bold text-white uppercase tracking-widest">TEAM EXECUTOR</h2></div>
            <div id="executor-tree-container" class="flex-grow flex items-start justify-center overflow-auto px-2 pb-20"></div>
        </div>
    </div>

    <!-- MODAL PASSWORD -->
    <div id="password-modal" class="custom-modal">
        <div id="password-box" class="bg-[#0f0505] border-2 border-red-800 rounded-2xl w-full max-w-xs mx-4 shadow-2xl text-center p-6 relative transition-transform">
            <div class="mb-4">
                <i class="fas fa-lock text-4xl text-red-600 mb-2"></i>
                <h3 class="text-lg font-bold text-white font-tech uppercase tracking-widest">Keamanan Data</h3>
            </div>
            
            <p class="text-gray-400 text-xs mb-3">Masukkan PIN Admin (Database D1)</p>
            
            <input type="password" id="admin-password" class="w-full bg-black border border-gray-700 rounded-lg py-3 px-4 text-white text-center focus:border-red-600 mb-4 tracking-[0.5em] text-lg outline-none transition-all" placeholder="••••">
            
            <!-- ERROR MESSAGE (PERSISTENT UNTIL TYPING) -->
            <div id="password-error" class="bg-red-950/80 border border-red-500 rounded p-2 mb-4 hidden animate-fade-in">
                <p class="text-red-400 text-[10px] font-bold uppercase flex items-center justify-center gap-2">
                    <i class="fas fa-exclamation-triangle"></i> <span id="error-text">PASSWORD SALAH!</span>
                </p>
            </div>

            <div class="flex gap-3">
                <button onclick="closeModalWithHistory('password-modal')" class="flex-1 py-2 rounded-lg border border-gray-700 text-gray-400 text-xs font-bold uppercase hover:bg-gray-900 transition-colors">Batal</button>
                <button id="btn-confirm-save" onclick="confirmAction()" class="flex-1 py-2 rounded-lg bg-red-800 text-white font-bold hover:bg-red-700 text-xs uppercase tracking-wider shadow-lg transition-all">VERIFIKASI</button>
            </div>
        </div>
    </div>

    <!-- MODAL EDIT / PREVIEW -->
    <div id="edit-modal" class="edit-modal">
        <div class="bg-[#0f0505] border border-red-800 rounded-2xl p-6 md:p-8 max-w-sm w-full mx-4 shadow-2xl relative">
            <button onclick="closeModalWithHistory('edit-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white p-2"><i class="fas fa-times text-xl"></i></button>
            <div id="edit-form-container">
                <h3 class="text-xl font-bold text-white mb-4 font-tech uppercase flex items-center gap-2"><i class="fas fa-pen-to-square text-red-500"></i>LENGKAPI DATA</h3>
                <div class="mb-6">
                    <label class="block text-red-500 text-[10px] font-bold uppercase mb-2 tracking-wider">Profile Mahasiswa</label>
                    <label for="input-file" class="cursor-pointer group relative block w-full">
                        <div class="w-full aspect-square bg-black/40 border-2 border-dashed border-gray-700 rounded-xl flex items-center justify-center overflow-hidden relative" id="preview-upload-container">
                             <div id="upload-placeholder" class="flex flex-col items-center justify-center"><i class="fas fa-camera text-gray-600 text-4xl mb-2"></i><span class="text-[10px] text-gray-600 uppercase font-bold">Upload Foto</span></div>
                             <img id="img-preview-edit" src="" class="absolute inset-0 w-full h-full object-cover hidden">
                        </div>
                        <input type="file" id="input-file" accept="image/*" class="hidden" onchange="handleFileSelect(this)">
                    </label>
                </div>
                <div class="mb-6">
                    <label class="block text-red-500 text-[10px] font-bold uppercase mb-2 tracking-wider">Nama Lengkap / Panggilan</label>
                    <input type="text" id="input-name" class="w-full bg-black/40 border border-gray-700 rounded-lg py-3 px-4 text-white focus:border-red-500 focus:outline-none placeholder-gray-700 text-sm" placeholder="Contoh: 'Fikri' atau Nama Lengkap..." autocomplete="off">
                    <p class="text-[10px] text-gray-600 mt-1">Ketik nama panggilan untuk auto-complete</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeModalWithHistory('edit-modal')" class="flex-1 py-3 rounded-lg border border-gray-700 text-gray-500 text-xs font-bold uppercase">Batal</button>
                    <button onclick="initiateAction('save')" class="flex-1 py-3 rounded-lg bg-red-800 text-white font-bold hover:bg-red-700 text-xs uppercase tracking-wide">Simpan</button>
                </div>
            </div>
            <div id="preview-container" class="hidden flex-col items-center text-center">
                <h3 id="modal-role-title" class="text-xl font-bold text-red-500 mb-2 font-tech uppercase tracking-widest">JABATAN</h3>
                <div class="w-full aspect-square bg-gray-900 rounded-xl overflow-hidden mb-4 mt-2 border-2 border-red-900 shadow-lg relative">
                     <img id="preview-img" src="" class="w-full h-full object-cover" referrerpolicy="no-referrer">
                </div>
                <h4 id="preview-name" class="text-white font-bold text-xl mb-1 font-body leading-tight">Nama Siswa</h4>
                <p id="preview-nim" class="text-red-400 font-tech text-sm mb-6 tracking-wider">NIM</p>
                <button onclick="initiateAction('delete')" class="w-full py-3 rounded-lg bg-red-900/20 border border-red-800 text-red-500 hover:bg-red-900 hover:text-white transition-colors font-bold uppercase text-xs tracking-widest flex items-center justify-center gap-2"><i class="fas fa-trash"></i> HAPUS DATA</button>
            </div>
        </div>
    </div>

    <!-- MODAL CROP -->
    <div id="crop-modal" class="custom-modal z-[300]">
        <div class="bg-[#0f0505] border-2 border-red-800 rounded-2xl w-full max-w-md mx-4 shadow-2xl flex flex-col h-[80vh]">
            <div class="p-4 border-b border-red-900/30 flex justify-between items-center bg-black/50 rounded-t-2xl">
                <h3 class="text-white font-bold font-tech tracking-wider"><i class="fas fa-crop-simple mr-2 text-red-500"></i>CROP FOTO</h3>
                <button onclick="closeCropModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-grow bg-black relative overflow-hidden flex items-center justify-center">
                <!-- Container untuk Cropper.js -->
                <div class="w-full h-full p-2">
                    <img id="image-to-crop" class="max-w-full max-h-full block">
                </div>
            </div>
            <div class="p-4 border-t border-red-900/30 bg-black/50 rounded-b-2xl flex gap-3">
                <button onclick="closeCropModal()" class="flex-1 py-3 rounded-lg border border-gray-700 text-gray-400 font-bold uppercase text-xs">Batal</button>
                <button onclick="cropAndSave()" class="flex-1 py-3 rounded-lg bg-red-700 text-white font-bold uppercase text-xs shadow-lg hover:bg-red-600">Potong & Pakai</button>
            </div>
        </div>
    </div>

    <script>
        // GANTI URL DI BAWAH INI DENGAN URL DEPLOYMENT GOOGLE APPS SCRIPT ANDA
        const STRUCTURE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyGAYfn8Yd3ARrZRF3lfKniBlr7iv2OpaloxOYqyG8puhWzihZq3m8BiVORyEcJRaMGEg/exec";
        
        const nicknameMap = {
            "ady": "Ady Surya", "fikri": "Ahmad Lubadul Fikri", "alyvia": "Alyvia Qurrotal Aini", "anggun": "Anggun Lolyk Hastuti",
            "aqilah": "Aqilah Mazaya", "arina": "Arina Manasika", "devi": "Devi Kurniasari", "elok": "Elok Iis Nurrohmah",
            "azizah": "Farikhatul Azizah", "hanan": "Hanan Tsuroya Akyasi", "hanni": "Hanni Hasanati", "juli": "Jembar Juli Yuasti",
            "lusi": "Lusi Rahmah Oktavia", "pniel": "Pniel Munandar", "putri": "Putri Dwi Astuti", "ayu": "Riska Ayu Kesuma",
            "ulfa": "Siti Ulfatur Rohmah", "tsabita": "Tsabita Hasna Hanifah", "ubaidillah": "Ubaidillah Musthofa",
            "yoana": "Yoana Dian Riski Astuti", "youvischa": "Youvischa Aulia Arsinta", "yuyun": "Yuyun Lutfiyatul Khoiriyah",
            "fadil": "Zain Nur Fadilah", "fakhry": "Muhammad Hanif Fakhry"
        };

        const semesterList = ["I", "II", "III", "IV", "V", "VI", "VII", "VIII"];
        let currentSemesterIndex = 0;
        let currentEditTarget = null;
        let pendingAction = null; 
        
        let semesterData = {}; 
        let studentDatabase = {}; 
        let tempImageBase64 = null;
        
        // Cropper Variables
        let cropperInstance = null;

        function openModalWithHistory(modalId) {
            history.pushState({modal: modalId}, null, "");
            if (modalId === 'team-executor-modal') {
                renderTeamExecutorTree(getSemesterData(semesterList[currentSemesterIndex]).executor);
                document.getElementById(modalId).classList.add('open');
                document.getElementById('main-content-wrapper').classList.add('blur-content');
                document.body.style.overflow = 'hidden';
            } else {
                document.getElementById(modalId).classList.add('active');
            }
        }

        function closeModalWithHistory(modalId) {
            if (history.state && history.state.modal === modalId) history.back();
            else closeModalUI(modalId);
        }

        function closeModalUI(modalId) {
            if (modalId === 'team-executor-modal') {
                document.getElementById(modalId).classList.remove('open');
                document.getElementById('main-content-wrapper').classList.remove('blur-content');
                document.body.style.overflow = '';
            } else {
                document.getElementById(modalId).classList.remove('active');
            }
        }

        window.onpopstate = function(event) {
            ['team-executor-modal', 'edit-modal', 'password-modal', 'crop-modal'].forEach(id => {
                const modal = document.getElementById(id);
                if (modal.classList.contains('active') || modal.classList.contains('open')) closeModalUI(id);
            });
        };

        function toggleFullscreen() {
            const elem = document.documentElement;
            const icon = document.getElementById('fs-icon');
            if (!document.fullscreenElement) {
                if (elem.requestFullscreen) { elem.requestFullscreen().catch(err => {}); }
                else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); }
                icon.classList.remove('fa-expand'); icon.classList.add('fa-compress');
            } else {
                if (document.exitFullscreen) { document.exitFullscreen(); }
                else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); }
                icon.classList.remove('fa-compress'); icon.classList.add('fa-expand');
            }
        }

        let touchStartX = 0; let touchEndX = 0;
        document.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, {passive: true});
        document.addEventListener('touchend', e => { 
            touchEndX = e.changedTouches[0].screenX;
            if (touchEndX < touchStartX - 50) nextSemester();
            if (touchEndX > touchStartX + 50) prevSemester();
        }, {passive: true});

        window.onload = function() {
            loadDataFromServer();
            document.getElementById('input-name').addEventListener('keypress', (e) => { if (e.key === 'Enter') initiateAction('save'); });
            document.getElementById('admin-password').addEventListener('keypress', (e) => { if (e.key === 'Enter') confirmAction(); });
            
            // REMOVE ERROR ON TYPING
            document.getElementById('admin-password').addEventListener('input', function() {
                const errBox = document.getElementById('password-error');
                if(!errBox.classList.contains('hidden')) {
                    errBox.classList.add('hidden');
                    this.classList.remove('border-red-600', 'text-red-500');
                    this.classList.add('border-gray-700', 'text-white');
                }
            });
        };

        function refreshData() {
            const btn = document.getElementById('btn-refresh');
            const icon = btn.querySelector('i');
            icon.classList.add('fa-spin'); btn.classList.add('opacity-50');
            loadDataFromServer().then(() => { setTimeout(() => { icon.classList.remove('fa-spin'); btn.classList.remove('opacity-50'); }, 500); });
        }

        async function loadDataFromServer() {
            const indicator = document.getElementById('loading-indicator');
            indicator.classList.remove('hidden');
            try {
                const response = await fetch(STRUCTURE_SCRIPT_URL + "?v=" + new Date().getTime());
                const result = await response.json();
                if (result.status === "success") {
                    studentDatabase = result.studentDb || {};
                    semesterData = result.structure || {};
                    if (Object.keys(semesterData).length === 0) semesterList.forEach(sem => semesterData[sem] = getEmptySemesterData());
                    updateSemesterDisplay(false);
                }
            } catch (error) { console.error("Gagal memuat data:", error); setTimeout(loadDataFromServer, 3000); } 
            finally { indicator.classList.add('hidden'); }
        }

        function getEmptySemesterData() {
            return { 
                main: { ketua: { name: "", img: "", nim: "" }, wakil: { name: "", img: "", nim: "" }, sek1: { name: "", img: "", nim: "" }, sek2: { name: "", img: "", nim: "" }, ben: { name: "", img: "", nim: "" }, ben1: { name: "", img: "", nim: "" }, ben2: { name: "", img: "", nim: "" } },
                executor: { koor: { name: "", img: "", nim: "" }, div_kreatif: Array(6).fill({name: "", img: "", nim: ""}), div_kebersihan: Array(5).fill({name: "", img: "", nim: ""}), div_sosial: Array(6).fill({name: "", img: "", nim: ""}) }
            };
        }
        function getSemesterData(sem) {
            if (!semesterData[sem]) semesterData[sem] = getEmptySemesterData();
            return semesterData[sem];
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const cropModal = document.getElementById('crop-modal');
                    const imageElement = document.getElementById('image-to-crop');
                    imageElement.src = e.target.result;
                    cropModal.classList.add('active');
                    if(cropperInstance) cropperInstance.destroy();
                    cropperInstance = new Cropper(imageElement, {
                        aspectRatio: 1, viewMode: 1, dragMode: 'move', autoCropArea: 1, responsive: true,
                        restore: false, guides: true, center: true, highlight: false, cropBoxMovable: true, cropBoxResizable: true, toggleDragModeOnDblclick: false,
                    });
                }
                reader.readAsDataURL(file);
            }
            input.value = '';
        }

        function closeCropModal() {
            document.getElementById('crop-modal').classList.remove('active');
            if(cropperInstance) { cropperInstance.destroy(); cropperInstance = null; }
        }

        function cropAndSave() {
            if(!cropperInstance) return;
            const canvas = cropperInstance.getCroppedCanvas({
                width: 800, height: 800, fillColor: '#fff', imageSmoothingEnabled: true, imageSmoothingQuality: 'high',
            });
            tempImageBase64 = canvas.toDataURL('image/jpeg', 0.9);
            document.getElementById('img-preview-edit').src = tempImageBase64;
            document.getElementById('img-preview-edit').classList.remove('hidden');
            document.getElementById('upload-placeholder').classList.add('opacity-0');
            closeCropModal();
        }

        function initiateAction(action) {
            pendingAction = action;
            // Reset error state
            const errBox = document.getElementById('password-error');
            const passInput = document.getElementById('admin-password');
            errBox.classList.add('hidden');
            passInput.value = '';
            passInput.classList.remove('border-red-600', 'text-red-500');
            
            if (history.state && history.state.modal === 'edit-modal') {
                history.back(); 
                setTimeout(() => { openModalWithHistory('password-modal'); document.getElementById('admin-password').focus(); }, 100);
            } else {
                 openModalWithHistory('password-modal');
                 document.getElementById('admin-password').focus();
            }
        }

        function confirmAction() {
            const password = document.getElementById('admin-password').value;
            if(pendingAction === 'save') saveMember(false, password);
            else if (pendingAction === 'delete') saveMember(true, password);
        }

        async function saveMember(isClear = false, password = "") {
            if (!currentEditTarget) return;
            const btn = document.getElementById('btn-confirm-save');
            const originalText = btn.innerText;
            btn.innerText = "MEMERIKSA..."; btn.disabled = true;

            const input = document.getElementById('input-name');
            let nameToSave = isClear ? "" : input.value.trim();
            
            if (!isClear && nameToSave) {
                const lowerName = nameToSave.toLowerCase();
                if (nicknameMap[lowerName]) nameToSave = nicknameMap[lowerName];
            }

            const { type, key, index } = currentEditTarget;
            const sem = semesterList[currentSemesterIndex];
            const currentDataObj = getSemesterData(sem);
            
            let oldData = (type === 'main') ? currentDataObj.main[key] : ((index !== null) ? currentDataObj.executor[key][index] : currentDataObj.executor[key]);
            let finalImg = "", finalNim = "-";

            if (!isClear) {
                finalNim = studentDatabase[nameToSave.toLowerCase()] || "-";
                // DO NOT CLEAR tempImageBase64 HERE ON FAIL
                // Use tempImageBase64 if available (newly cropped), otherwise use old image, otherwise avatar
                finalImg = tempImageBase64 ? tempImageBase64 : (oldData && oldData.img ? oldData.img : `https://ui-avatars.com/api/?name=${encodeURIComponent(nameToSave)}&background=300505&color=ffffff&bold=true`);
            }

            const newData = { name: nameToSave, img: finalImg, nim: finalNim };
            const previousData = JSON.parse(JSON.stringify(currentDataObj)); // Backup

            // Optimistic Update
            if (type === 'main') currentDataObj.main[key] = newData;
            else { if (index !== null) currentDataObj.executor[key][index] = newData; else currentDataObj.executor[key] = newData; }
            updateStructureUI(sem); 
            
            try {
                const res = await fetch(STRUCTURE_SCRIPT_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ password: password, structure: semesterData }) 
                });
                const result = await res.json();
                
                if (result.status === "success") {
                    btn.innerText = "BERHASIL";
                    setTimeout(() => { 
                        closeModalWithHistory('password-modal'); 
                        btn.innerText = originalText; 
                        btn.disabled = false;
                        // HANYA RESET JIKA SUKSES
                        input.value = ""; 
                        currentEditTarget = null; 
                        tempImageBase64 = null; 
                    }, 800);
                } else {
                    throw new Error(result.message);
                }
            } catch (e) {
                // REVERT DATA
                if (type === 'main') currentDataObj.main = previousData.main;
                else currentDataObj.executor = previousData.executor;
                updateStructureUI(sem); 

                // SHOW ERROR VISUALLY
                const errorMsg = e.message || "PASSWORD SALAH!";
                const errorEl = document.getElementById('password-error');
                document.getElementById('error-text').innerText = errorMsg;
                errorEl.classList.remove('hidden');
                
                const passBox = document.getElementById('password-box');
                passBox.classList.remove('animate-shake');
                void passBox.offsetWidth; // Force reflow
                passBox.classList.add('animate-shake');
                
                const passInput = document.getElementById('admin-password');
                passInput.classList.remove('border-gray-700', 'text-white');
                passInput.classList.add('border-red-600', 'text-red-500');
                passInput.focus();

                btn.innerText = originalText; btn.disabled = false;
                // DO NOT RESET tempImageBase64 HERE
            }
        }

        function updateSemesterDisplay(animate = true) { 
            const sem = semesterList[currentSemesterIndex]; 
            const executorContainer = document.getElementById('executor-btn-container');
            const displayEl = document.getElementById('current-semester-display');
            const contentWrapper = document.getElementById('structure-content-wrapper');

            document.getElementById('btn-prev-sem').style.visibility = (currentSemesterIndex === 0) ? 'hidden' : 'visible';
            document.getElementById('btn-next-sem').style.visibility = (currentSemesterIndex === semesterList.length - 1) ? 'hidden' : 'visible';
            
            if (currentSemesterIndex === 0) { executorContainer.classList.remove('flex'); executorContainer.classList.add('hidden'); } 
            else { executorContainer.classList.remove('hidden'); executorContainer.classList.add('flex'); }

            if (animate) {
                contentWrapper.style.opacity = '0';
                setTimeout(() => {
                    displayEl.innerText = `SEMESTER ${sem}`;
                    updateStructureUI(sem);
                    contentWrapper.style.opacity = '1';
                }, 200);
            } else { displayEl.innerText = `SEMESTER ${sem}`; updateStructureUI(sem); }
        }

        function nextSemester() { if (currentSemesterIndex < semesterList.length - 1) { currentSemesterIndex++; updateSemesterDisplay(); } }
        function prevSemester() { if (currentSemesterIndex > 0) { currentSemesterIndex--; updateSemesterDisplay(); } }

        function updateStructureUI(sem) { 
            const dataMain = getSemesterData(sem).main;
            const container = document.getElementById('structure-content-container');
            
            if (sem === "I") {
                container.innerHTML = `
                <div class="flex flex-col items-center w-full gap-6 md:gap-10 mt-2 animate-fade-in pb-10">
                    <div class="flex flex-col md:flex-row justify-center gap-6 md:gap-12 w-full px-2">
                        <div class="grid grid-cols-2 gap-2 w-full md:w-auto place-items-center">
                             ${createDynamicCard('ketua', "Ketua Kelas", dataMain.ketua)}
                             ${createDynamicCard('wakil', "Wakil Ketua", dataMain.wakil)}
                        </div>
                    </div>
                    <div class="w-full max-w-5xl border-t border-red-900/30 my-2"></div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-8 w-full max-w-6xl px-2 place-items-center">
                        ${createDynamicCard('sek1', "Sekretaris 1", dataMain.sek1)}
                        ${createDynamicCard('sek2', "Sekretaris 2", dataMain.sek2)}
                        ${createDynamicCard('ben1', "Bendahara 1", dataMain.ben1)}
                        ${createDynamicCard('ben2', "Bendahara 2", dataMain.ben2)}
                    </div>
                </div>`;
            } else {
                container.innerHTML = `
                <div class="flex flex-col items-center w-full gap-4 md:gap-10 mt-4 animate-fade-in pb-10">
                    <div class="flex justify-center w-full">
                        <div class="w-[46vw] md:w-auto flex justify-center">${createDynamicCard('ketua', "Ketua Kelas", dataMain.ketua)}</div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 justify-center w-full px-2 md:flex md:gap-12 md:w-auto">
                        ${createDynamicCard('sek1', "Sekretaris 1", dataMain.sek1)}
                        ${createDynamicCard('sek2', "Sekretaris 2", dataMain.sek2)}
                    </div>
                    <div class="flex justify-center w-full">
                        <div class="w-[46vw] md:w-auto flex justify-center">${createDynamicCard('ben', "Bendahara", dataMain.ben)}</div>
                    </div>
                </div>`;
            }
        }

        function renderTeamExecutorTree(dataEx) {
            const container = document.getElementById('executor-tree-container');
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-12 mt-4 w-full max-w-7xl animate-fade-in">
                    <div class="flex flex-col items-center gap-4">
                        <div class="w-full bg-orange-900/20 border border-orange-500/30 rounded-lg py-2 text-center mb-2"><div class="text-orange-400 text-lg font-bold font-tech uppercase tracking-widest">KREATIF</div></div>
                        <div class="grid grid-cols-2 gap-2 w-full place-items-center">${dataEx.div_kreatif.map((m, i) => createDynamicCard('div_kreatif', `Creative ${i+1}`, m, 'executor', i)).join('')}</div>
                    </div>
                    <div class="flex flex-col items-center gap-4">
                         <div class="w-full bg-red-900/20 border border-red-500/30 rounded-lg py-2 text-center mb-2"><div class="text-red-400 text-lg font-bold font-tech uppercase tracking-widest">KEBERSIHAN</div></div>
                        <div class="grid grid-cols-2 gap-2 w-full place-items-center">${dataEx.div_kebersihan.map((m, i) => createDynamicCard('div_kebersihan', `Cleaner ${i+1}`, m, 'executor', i)).join('')}</div>
                    </div>
                    <div class="flex flex-col items-center gap-4">
                         <div class="w-full bg-yellow-900/20 border border-yellow-500/30 rounded-lg py-2 text-center mb-2"><div class="text-yellow-400 text-lg font-bold font-tech uppercase tracking-widest">SOSIAL</div></div>
                        <div class="grid grid-cols-2 gap-2 w-full place-items-center">${dataEx.div_sosial.map((m, i) => createDynamicCard('div_sosial', `Social ${i+1}`, m, 'executor', i)).join('')}</div>
                    </div>
                </div>`;
        }

        function createDynamicCard(key, label, data, type = 'main', index = null) {
            const name = data?.name || "";
            const nim = data?.nim || "";
            const img = name ? (data.img || "https://ui-avatars.com/api/?name=User&background=300505&color=ffffff") : "";
            const params = `'${type}', '${key}', ${index}, '${label}'`;

            if (!name) return `
                <div class="glass-panel empty-slot p-2 rounded-xl inline-flex flex-col card-container cursor-pointer group overflow-hidden transition-transform duration-200 active:scale-95" onclick="openModalWithHistory('edit-modal'); openEditModal(${params});">
                    <div class="flex-grow flex flex-col items-center justify-center opacity-70 group-hover:opacity-100 transition-opacity">
                        <div class="w-16 h-16 rounded-full mb-2 flex items-center justify-center border border-dashed border-gray-500 text-gray-500 group-hover:text-red-400 group-hover:border-red-400 transition-colors text-2xl"><i class="fas fa-plus"></i></div>
                        <span class="text-[10px] md:text-xs text-gray-500 group-hover:text-red-300 font-bold uppercase tracking-wider">Isi Data</span>
                    </div>
                    <p class="text-[10px] text-gray-600 uppercase mt-auto flex-shrink-0 pt-2 border-t border-white/5 tracking-wider w-full text-center">${label}</p>
                </div>`;

            return `
                <div class="glass-panel p-1.5 rounded-xl inline-flex flex-col card-container cursor-pointer group transition-transform duration-200 active:scale-95" onclick="openModalWithHistory('edit-modal'); openEditModal(${params});">
                    <div class="flex-grow w-full overflow-hidden relative rounded-lg">
                        <img src="${img}" class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-500">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-60"></div>
                    </div>
                    <div class="flex flex-col items-center w-full pt-2 pb-1 px-1">
                        <h3 class="font-bold text-white text-xs md:text-sm leading-tight text-center mb-0.5 line-clamp-2">${name}</h3>
                        <p class="text-red-500 text-[10px] font-tech font-bold tracking-wider mb-1">${nim || "-"}</p>
                        <p class="text-[9px] text-red-400/80 uppercase font-tech pt-1 border-t border-red-900/30 w-full tracking-wider text-center truncate">${label}</p>
                    </div>
                </div>`;
        }

        function openEditModal(type, key, index = null, labelName = 'ANGGOTA') {
            currentEditTarget = { type, key, index };
            const data = getSemesterData(semesterList[currentSemesterIndex]);
            let target = (type === 'main') ? data.main[key] : (index !== null ? data.executor[key][index] : data.executor[key]);
            
            const form = document.getElementById('edit-form-container');
            const preview = document.getElementById('preview-container');
            
            document.getElementById('input-file').value = "";
            tempImageBase64 = null;
            document.getElementById('modal-role-title').innerText = labelName.toUpperCase();

            if (target && target.name) {
                form.classList.add('hidden'); preview.classList.remove('hidden'); preview.classList.add('flex');
                document.getElementById('preview-img').src = target.img || "";
                document.getElementById('preview-name').innerText = target.name;
                document.getElementById('preview-nim').innerText = target.nim || "-";
            } else {
                form.classList.remove('hidden'); preview.classList.add('hidden');
                document.getElementById('input-name').value = "";
                document.getElementById('img-preview-edit').src = "";
                document.getElementById('img-preview-edit').classList.add('hidden');
                document.getElementById('upload-placeholder').classList.remove('opacity-0');
                setTimeout(() => document.getElementById('input-name').focus(), 100);
            }
        }
    </script>
</body>
</html>
